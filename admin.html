<!DOCTYPE html>
<h2 style="margin:0 0 8px">Daftar Program</h2>
<table id="tbl"><thead>
<tr><th>Judul</th><th>Kategori/Tahun/Status</th><th>PI/URL</th><th style="width:120px">Aksi</th></tr>
</thead><tbody></tbody></table>
<div class="muted" id="hint"></div>
</div>
</div>
</div>


<div class="toast" id="toast"></div>


<script>
const $ = (s,e=document)=>e.querySelector(s);
const els = { tbl:$('#tbl tbody'), hint:$('#hint'), toast:$('#toast'), btnSetToken:$('#btnSetToken'), btnRefresh:$('#btnRefresh'), btnTambah:$('#btnTambah') };
const API_BASE='/api/programs';
const getToken=()=>localStorage.getItem('lppm-admin-token')||'';
const setToken=(t)=>localStorage.setItem('lppm-admin-token', t);
function showToast(m){ const t=els.toast; t.textContent=m; t.style.display='block'; clearTimeout(showToast._t); showToast._t=setTimeout(()=>t.style.display='none',1500); }
function isHttpUrl(s){ try{ const u=new URL(s); return /^https?:$/.test(u.protocol)}catch{return false} }
function toId(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,60)}


async function list(){
els.tbl.innerHTML='';
const r = await fetch(API_BASE);
if(!r.ok){ els.hint.textContent='Gagal memuat data. Pastikan API & Vercel KV sudah dikonfigurasi.'; return; }
const data = await r.json();
if(!Array.isArray(data) || !data.length){ els.tbl.innerHTML='<tr><td colspan="4" class="muted">Belum ada data</td></tr>'; return; }
for(const it of data){
const tr=document.createElement('tr');
tr.innerHTML=`<td><strong>${it.judul||''}</strong><div class="muted">${it.ringkas||''}</div></td>
<td><div>${it.kategori||''}</div><div class="muted">${it.tahun||''} • ${it.status||''}</div></td>
<td><div>${it.pi||''}</div><div class="muted">${it.url?`<a href="${it.url}" target="_blank" rel="noopener">${it.url}</a>`:'—'}</div></td>
<td><button class="btn danger" data-id="${it.id}">Hapus</button></td>`;
tr.querySelector('[data-id]')?.addEventListener('click',()=>del(it.id));
els.tbl.appendChild(tr);
}
}


async function add(){
const judul=$('#fJudul').value.trim(); const pi=$('#fPI').value.trim(); const url=$('#fURL').value.trim();
const kategori=$('#fKategori').value; const tahun=Number($('#fTahun').value); const status=$('#fStatus').value; const ringkas=$('#fRingkas').value.trim();
if(!judul||!pi){ return showToast('Judul dan PI wajib.'); }
if(url && !isHttpUrl(url)){ return showToast('URL harus http(s)://'); }
const id=toId(judul);
const r = await fetch(API_BASE,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+getToken()},body:JSON.stringify({id,judul,pi,url,kategori,tahun,status,ringkas})});
if(!r.ok){ showToast('Gagal tambah. Cek token & KV.'); return; }
showToast('Tersimpan.'); list();
}


async function del(id){
if(!confirm('Hapus program ini?')) return;
const r = await fetch(`${API_BASE}/${encodeURIComponent(id)}`,{method:'DELETE',headers:{'Authorization':'Bearer '+getToken()}});
if(!r.ok){ showToast('Gagal hapus. Cek token & KV.'); return; }
showToast('Terhapus.'); list();
}


els.btnSetToken.addEventListener('click',()=>{ const v=prompt('Masukkan ADMIN_TOKEN:'); if(v) setToken(v); });
els.btnRefresh.addEventListener('click', list);
els.btnTambah.addEventListener('click', add);
list();
</script>
</body>
</html>